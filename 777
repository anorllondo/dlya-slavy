
import sqlite3
import os
import xml.etree.ElementTree as ET
from fastapi import FastAPI, Request, Form
from fastapi.responses import HTMLResponse, FileResponse
from fastapi.templating import Jinja2Templates

app = FastAPI()
current_dir = os.path.dirname(os.path.realpath(__file__))
templates = Jinja2Templates(directory=os.path.join(current_dir, "templates"))

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î (–ñ–∏–≤–æ–ø–∏—Å—å)
def init_db():
    con = sqlite3.connect('art_gallery.db')
    cur = con.cursor()
    
    cur.execute('DROP TABLE IF EXISTS paintings')
    cur.execute('DROP TABLE IF EXISTS artists')
    
    cur.execute('''
        CREATE TABLE artists (
            id INTEGER PRIMARY KEY AUTOINCREMENT, 
            name TEXT, 
            country TEXT, 
            birth_year INTEGER,
            style TEXT
        )
    ''')
    
    cur.execute('''
        CREATE TABLE paintings (
            id INTEGER PRIMARY KEY AUTOINCREMENT, 
            artist_id INTEGER, 
            title TEXT, 
            year INTEGER,
            technique TEXT,
            FOREIGN KEY(artist_id) REFERENCES artists(id)
        )
    ''')
    
    initial_artists = [
        ('–í–∏–Ω—Å–µ–Ω—Ç –í–∞–Ω –ì–æ–≥', '–ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã', 1853, '–ü–æ—Å—Ç–∏–º–ø—Ä–µ—Å—Å–∏–æ–Ω–∏–∑–º'),
        ('–õ–µ–æ–Ω–∞—Ä–¥–æ –¥–∞ –í–∏–Ω—á–∏', '–ò—Ç–∞–ª–∏—è', 1452, '–†–µ–Ω–µ—Å—Å–∞–Ω—Å'),
        ('–ö–ª–æ–¥ –ú–æ–Ω–µ', '–§—Ä–∞–Ω—Ü–∏—è', 1840, '–ò–º–ø—Ä–µ—Å—Å–∏–æ–Ω–∏–∑–º')
    ]
    cur.executemany('INSERT INTO artists (name, country, birth_year, style) VALUES (?,?,?,?)', initial_artists)
    
    cur.execute('INSERT INTO paintings (artist_id, title, year, technique) VALUES (1, "–ó–≤–µ–∑–¥–Ω–∞—è –Ω–æ—á—å", 1889, "–ú–∞—Å–ª–æ")')
    cur.execute('INSERT INTO paintings (artist_id, title, year, technique) VALUES (2, "–ú–æ–Ω–∞ –õ–∏–∑–∞", 1503, "–ú–∞—Å–ª–æ")')
    cur.execute('INSERT INTO paintings (artist_id, title, year, technique) VALUES (3, "–í–æ–¥—è–Ω—ã–µ –ª–∏–ª–∏–∏", 1916, "–ú–∞—Å–ª–æ")')
    
    con.commit()
    con.close()

init_db()

def get_db_conn():
    conn = sqlite3.connect('art_gallery.db')
    conn.row_factory = sqlite3.Row
    return conn

@app.get("/", response_class=HTMLResponse)
async def index(request: Request):
    con = get_db_conn()
    artists = con.execute('SELECT * FROM artists').fetchall()
    paintings = con.execute('SELECT p.*, a.name as artist_name FROM paintings p JOIN artists a ON p.artist_id = a.id').fetchall()
    con.close()
    return templates.TemplateResponse("index.html", {
        "request": request,
        "artists": artists,
        "paintings": paintings
    })

@app.post("/add_artist")
async def add_artist(name: str = Form(...), country: str = Form(...), birth_year: int = Form(...), style: str = Form(...)):
    con = get_db_conn()
    con.execute('INSERT INTO artists (name, country, birth_year, style) VALUES (?, ?, ?, ?)', (name, country, birth_year, style))
    con.commit()
    con.close()
    return {"status": "–•—É–¥–æ–∂–Ω–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω"}

@app.post("/add_painting")
async def add_painting(artist_id: int = Form(...), title: str = Form(...), year: int = Form(...), technique: str = Form(...)):
    con = get_db_conn()
    con.execute('INSERT INTO paintings (artist_id, title, year, technique) VALUES (?, ?, ?, ?)', (artist_id, title, year, technique))
    con.commit()
    con.close()
    return {"status": "–ö–∞—Ä—Ç–∏–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞"}

@app.get("/export/xml")
def export_xml():
    con = get_db_conn()
    artists = con.execute('SELECT * FROM artists').fetchall()
    con.close()

    root = ET.Element("art_gallery")
    for a in artists:
        artist_node = ET.SubElement(root, "artist")
        ET.SubElement(artist_node, "name").text = str(a["name"])
        ET.SubElement(artist_node, "country").text = str(a["country"])
        ET.SubElement(artist_node, "birth_year").text = str(a["birth_year"])
        ET.SubElement(artist_node, "style").text = str(a["style"])

    tree = ET.ElementTree(root)
    xml_path = "artists_data.xml"
    tree.write(xml_path, encoding="utf-8", xml_declaration=True)
    return FileResponse(xml_path)

@app.post("/import/xml")
def import_xml():
    if not os.path.exists("artists_data.xml"):
        return {"error": "–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"}
    
    tree = ET.parse("artists_data.xml")
    root = tree.










<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ì–∞–ª–µ—Ä–µ—è –∏—Å–∫—É—Å—Å—Ç–≤</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; margin: 20px 0; }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
        th { background-color: #f4f4f4; }
        .form-section { background: #f9f9f9; padding: 15px; border-radius: 5px; margin: 15px 0; }
        input, select { margin: 5px; padding: 8px; width: 200px; }
        button { padding: 10px 15px; cursor: pointer; background: #2c3e50; color: white; border: none; border-radius: 3px; }
        .xml-btns { margin: 20px 0; }
        .section-title { color: #34495e; border-bottom: 2px solid #3498db; padding-bottom: 5px; }
    </style>
</head>
<body>
    <h1>üé® –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö "–ì–∞–ª–µ—Ä–µ—è –∏—Å–∫—É—Å—Å—Ç–≤"</h1>

    <div class="form-section">
        <h3 class="section-title">–î–æ–±–∞–≤–∏—Ç—å —Ö—É–¥–æ–∂–Ω–∏–∫–∞</h3>
        <form action="/add_artist" method="post">
            <input type="text" name="name" placeholder="–ò–º—è —Ö—É–¥–æ–∂–Ω–∏–∫–∞" required><br>
            <input type="text" name="country" placeholder="–°—Ç—Ä–∞–Ω–∞" required><br>
            <input type="number" name="birth_year" placeholder="–ì–æ–¥ —Ä–æ–∂–¥–µ–Ω–∏—è" required><br>
            <input type="text" name="style" placeholder="–°—Ç–∏–ª—å" required><br>
            <button type="submit">–î–æ–±–∞–≤–∏—Ç—å —Ö—É–¥–æ–∂–Ω–∏–∫–∞</button>
        </form>
    </div>

    <div class="form-section">
        <h3 class="section-title">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω—É</h3>
        <form action="/add_painting" method="post">
            <select name="artist_id" required>
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ö—É–¥–æ–∂–Ω–∏–∫–∞</option>
                {% for a in artists %}
                <option value="{{ a.id }}">{{ a.name }}</option>
                {% endfor %}
            </select><br>
            <input type="text" name="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω—ã" required><br>
            <input type="number" name="year" placeholder="–ì–æ–¥ —Å–æ–∑–¥–∞–Ω–∏—è" required><br>
            <input type="text" name="technique" placeholder="–¢–µ—Ö–Ω–∏–∫–∞" required><br>
            <button type="submit">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω—É</button>
        </form>
    </div>

    <div class="xml-btns">
        <h3 class="section-title">–≠–∫—Å–ø–æ—Ä—Ç/–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
        <a href="/export/xml"><button style="background: #3498db;">–≠–∫—Å–ø–æ—Ä—Ç –≤ XML</button></a>
        <form action="/import/xml" method="post" style="display:inline;">
            <button type="submit" style="background: #7f8c8d;">–ò–º–ø–æ—Ä—Ç –∏–∑ XML</button>
        </form>
    </div>

    <hr>

    <h2 class="section-title">–•—É–¥–æ–∂–Ω–∏–∫–∏</h2>
    <table>
        <tr><th>ID</th><th>–ò–º—è</th><th>–°—Ç—Ä–∞–Ω–∞</th><th>–ì–æ–¥ —Ä–æ–∂–¥–µ–Ω–∏—è</th><th>–°—Ç–∏–ª—å</th></tr>
        {% for a in artists %}
        <tr><td>{{ a.id }}</td><td>{{ a.name }}</td><td>{{ a.country }}</td><td>{{ a.birth_year }}</td><td>{{ a.style }}</td></tr>
        {% endfor %}
    </table>

    <h2 class="section-title">–ö–∞—Ä—Ç–∏–Ω—ã</h2>
    <table>
        <tr><th>ID</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–•—É–¥–æ–∂–Ω–∏–∫</th><th>–ì–æ–¥</th><th>–¢–µ—Ö–Ω–∏–∫–∞</th></tr>
        {% for p in paintings %}
        <tr><td>{{ p.id }}</td><td>{{ p.title }}</td><td>{{ p.artist_name }}</td><td>{{ p.year }}</td><td>{{ p.technique }}</td></tr>
        {% endfor %}
    </table>
</body>
</html>
